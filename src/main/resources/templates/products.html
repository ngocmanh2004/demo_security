<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{title.products}">Danh s√°ch s·∫£n ph·∫©m</title>
    <link rel="stylesheet" href="/css/app.css?v=2">
    <style>
        /* small overrides for products page */
        body { }
    </style>
</head>
<body>
<div class="navbar">
    <h1 th:text="#{title.home}">C·ª≠a h√†ng c·ªßa ch√∫ng t√¥i</h1>
    <div class="navbar-right">
        <div style="margin-right:8px;">
            <a id="adminLink" href="/admin.html" style="margin-right:12px; color: #e6eef8; display:none">Admin</a>
            <a href="/products.html" style="margin-right:12px; color: #e6eef8">Trang s·∫£n ph·∫©m</a>
            <a href="?lang=vi" style="margin-right:8px; color: #e6eef8">VI</a>
            <a href="?lang=en" style="color: #e6eef8">EN</a>
        </div>
        <div class="user-info" style="color:#e6eef8; margin-right:8px;">
            <span id="username"></span>
            <span id="role" style="font-size:13px; margin-left:6px; background:rgba(255,255,255,0.08); padding:2px 8px; border-radius:8px;"></span>
        </div>
        <button class="btn-logout" onclick="logout()" th:text="#{label.logout}">ƒêƒÉng xu·∫•t</button>
    </div>
</div>

<div class="container">
    <h2 th:text="#{title.products}">Danh s√°ch s·∫£n ph·∫©m</h2>
    <div id="loading" class="loading">ƒêang t·∫£i s·∫£n ph·∫©m...</div>
    <div id="error" class="error" style="display: none;"></div>
    <!-- Category filter pills -->
    <div id="categoryFilter" class="category-filter"></div>
    <div id="productsGrid" class="products-grid"></div>
</div>

<script>
    // Use relative API path so frontend works regardless of server port
    const API_URL = '/api';

    // Check authentication
    function checkAuth() {
        const token = localStorage.getItem('accessToken');
        const roles = JSON.parse(localStorage.getItem('roles') || '[]');
        const username = localStorage.getItem('username') || '';
        // Detect language from URL param or default to 'vi'
        const urlParams = new URLSearchParams(window.location.search);
        const lang = urlParams.get('lang') || 'vi';
        let roleText = '';
        if (roles.includes('ROLE_ADMIN')) roleText = lang === 'en' ? 'Admin' : 'Qu·∫£n tr·ªã vi√™n';
        else if (roles.includes('ROLE_MANAGER')) roleText = lang === 'en' ? 'Manager' : 'Qu·∫£n l√Ω';
        else if (roles.includes('ROLE_USER')) roleText = lang === 'en' ? 'User' : 'Ng∆∞·ªùi d√πng';

        if (document.getElementById('username')) document.getElementById('username').textContent = username;
        if (document.getElementById('role')) document.getElementById('role').textContent = roleText;

        // Show admin link only for admin/manager roles
        const adminLink = document.getElementById('adminLink');
        if (adminLink) {
            if (roles.includes('ROLE_ADMIN') || roles.includes('ROLE_MANAGER')) {
                adminLink.style.display = 'inline';
            } else {
                adminLink.style.display = 'none';
            }
        }

        if (!token) {
            window.location.href = 'login.html';
            return false;
        }
        // Store lang for use in other functions
        window.currentLang = lang;
        return true;
    }

    // Load categories and render as pills
    async function loadCategories(selectedCategoryId = null) {
        const filterDiv = document.getElementById('categoryFilter');
        filterDiv.innerHTML = '';
        try {
            const lang = window.currentLang || 'vi';
            const res = await fetch(`${API_URL}/public/products/categories?lang=${lang}`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('accessToken')}` }
            });
            if (!res.ok) return;
            const cats = await res.json();

            // Add an 'All' pill
            const allPill = document.createElement('div');
            allPill.className = 'category-pill' + (selectedCategoryId == null ? ' active' : '');
            allPill.dataset.id = '';
            allPill.textContent = lang === 'en' ? 'All' : 'T·∫•t c·∫£';
            allPill.onclick = () => {
                setActiveCategory(null);
                loadProducts();
            };
            filterDiv.appendChild(allPill);

            cats.forEach(c => {
                const pill = document.createElement('div');
                pill.className = 'category-pill' + (selectedCategoryId === c.productCategoryID ? ' active' : '');
                pill.dataset.id = String(c.productCategoryID);
                pill.textContent = c.categoryName || (lang === 'en' ? `Category ${c.productCategoryID}` : `Danh m·ª•c ${c.productCategoryID}`);
                pill.onclick = () => {
                    setActiveCategory(c.productCategoryID);
                    loadProducts(c.productCategoryID);
                };
                filterDiv.appendChild(pill);
            });
        } catch (e) {
            console.error('Failed to load categories', e);
        }
    }

    function setActiveCategory(id) {
        const pills = document.querySelectorAll('.category-pill');
        pills.forEach(p => p.classList.remove('active'));
        if (id == null) {
            const first = document.querySelector('.category-pill[data-id=""]');
            if (first) first.classList.add('active');
            return;
        }
        const selected = document.querySelector('.category-pill[data-id="' + String(id) + '"]');
        if (selected) selected.classList.add('active');
    }

    // Load products
    async function loadProducts(categoryId = null) {
        if (!checkAuth()) return;

        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const productsGrid = document.getElementById('productsGrid');

        try {
            const lang = window.currentLang || 'vi';
            const endpoint = categoryId ? `${API_URL}/public/products/category/${categoryId}?lang=${lang}` : `${API_URL}/public/products?lang=${lang}`;
            // update loading state for category
            loadingDiv.style.display = 'block';
            productsGrid.innerHTML = '';

            const response = await fetch(endpoint, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                }
            });

            if (response.ok) {
                const products = await response.json();
                loadingDiv.style.display = 'none';

                if (products.length === 0) {
                    productsGrid.innerHTML = `<p style="text-align:center; color:#666;">${lang === 'en' ? 'No products yet.' : 'Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o.'}</p>`;
                    return;
                }

                productsGrid.innerHTML = products.map(product => `
                    <div class="product-card">
                        <div class="product-image">
                            ${product.imageUrl ?
                                `<img src="${product.imageUrl}" alt="${product.productName}">` :
                                (lang === 'en' ? 'üì¶ No Image' : 'üì¶ Kh√¥ng c√≥ ·∫£nh')}
                        </div>
                        <div class="product-info">
                            <div class="product-name">${product.productName || (lang === 'en' ? 'Product' : 'S·∫£n ph·∫©m')}</div>
                            <div class="product-description">
                                ${product.description || (lang === 'en' ? 'No description' : 'Kh√¥ng c√≥ m√¥ t·∫£')}
                            </div>
                            <div class="product-footer">
                                <div class="product-price">
                                    ${product.price ? Number(product.price).toLocaleString(lang === 'en' ? 'en-US' : 'vi-VN') + (lang === 'en' ? ' ‚Ç´' : ' ‚Ç´') : (lang === 'en' ? 'Contact' : 'Li√™n h·ªá')}
                                </div>
                                <div class="product-stock">
                                    ${lang === 'en' ? 'Stock' : 'Kho'}: ${product.stockQuantity || 0}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else if (response.status === 401) {
                window.location.href = 'login.html';
            } else {
                throw new Error('Failed to load products');
            }
        } catch (error) {
            loadingDiv.style.display = 'none';
            errorDiv.style.display = 'block';
            errorDiv.textContent = (window.currentLang === 'en' ? 'Cannot load product list!' : 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m!');
            console.error(error);
        }
    }

    // Logout
    async function logout() {
        const refreshToken = localStorage.getItem('refreshToken');

        try {
            await fetch(`${API_URL}/auth/logout`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ refreshToken })
            });
        } catch (error) {
            console.error('Logout error:', error);
        }

        localStorage.clear();
        window.location.href = 'login.html';
    }

    // Initialize: load categories first then products
    (async function init() {
        if (!checkAuth()) return;
        await loadCategories();
        await loadProducts();
    })();
</script>
</body>
</html>